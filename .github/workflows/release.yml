name: Release and Version Update

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: èŽ·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION=${VERSION#v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç‰ˆæœ¬å·: $VERSION"

      - name: æ›´æ–° package.json ç‰ˆæœ¬
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          npm version $VERSION --no-git-tag-version
          echo "âœ… package.json ç‰ˆæœ¬å·²æ›´æ–°ä¸º $VERSION"

      - name: æ›´æ–° CHANGELOG.md
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          
          # åˆ›å»ºæ–°çš„å˜æ›´æ—¥å¿—æ¡ç›®
          cat > /tmp/new_entry.md << EOF
          ## [$VERSION] - $DATE

          ### å‘å¸ƒè¯´æ˜Ž
          - ðŸš€ ç‰ˆæœ¬ $VERSION å‘å¸ƒ
          - ðŸ“ é€šè¿‡ GitHub Release è‡ªåŠ¨æ›´æ–°

          EOF
          
          # åœ¨ CHANGELOG.md ä¸­æ’å…¥æ–°æ¡ç›®ï¼ˆåœ¨ç¬¬ä¸€ä¸ª ## ä¹‹å‰ï¼‰
          if [ -f CHANGELOG.md ]; then
            sed -i.bak "/^## \[/r /tmp/new_entry.md" CHANGELOG.md && rm CHANGELOG.md.bak || true
          fi
          
          echo "âœ… CHANGELOG.md å·²æ›´æ–°"

      - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          mkdir -p public
          cat > public/version.json << EOF
          {
            "version": "$VERSION",
            "buildDate": "$DATE",
            "commitSha": "$COMMIT_SHA",
            "gitTag": "v$VERSION"
          }
          EOF
          
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å·²åˆ›å»º"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          git add package.json CHANGELOG.md public/version.json
          
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "chore: bump version to $VERSION [skip ci]"
            git push origin HEAD:main || git push origin HEAD:master
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤"
          fi

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        if: github.event_name == 'release'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "## ðŸŽ‰ ç‰ˆæœ¬ $VERSION å·²å‘å¸ƒï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/openapi-to-mcp-server:$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/openapi-to-mcp-server:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

